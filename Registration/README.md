# 3D点云配准

3D点云配准是指将变化的3D点云数据对齐到一个完整的模型。目的是寻找获取的分离的3D视图的相对位置和方向，并它们在一个全局坐标系整合成一个模型，必须寻找不同的View的完全重合的感兴趣区域。每个点云数据集都是从不同的视角获取的，因此需要一个系统，把它们对齐到一个统一的的坐标系下，形成单一的点云模型，然后可以在这个单一的模型的进行高级的操作，比如分割和目标重构等。

![一个示意图](http://pointclouds.org/documentation/tutorials/_images/scans.jpg)

比如上面的图，使用一个倾斜的2D激光单元获取的6个独立的数据集，每个独立的扫描只能看到周围世界的一个很小的部分，因此需要一种方法，将它们组合在一起，组成一个完整的点云模型，如下图所示。
![配准结果](http://pointclouds.org/documentation/tutorials/_images/s1-6.jpg)

PCL点云配准库函数就是在给定的输入点云数据集中找出正确的对应关系，在全局坐标系中估计出每个独立数据集的刚体变换矩阵（旋转和平移）。如果每个点的对应能够完美的获取，那么配准程序就会变得很容易解决。这就意味着在一个数据集中选择的点列表，在特征表达点的角度，与另一个数据集的具有一致性。另外，如果对应估计的很完美，那么这个配准问题已经接近解决了。
PCL包含了一个功能强大的算法集合，这个算法集合能够估计多个数据集的对应关系，同时，能够拒绝坏的对应关系，采用鲁邦的方式估计它们的变换关系，这个目录下的其他部分用来描述这些算法。

## 整体预览成对配准
有时候称作点云数据库中的一对点的匹配到一起的问题为成对配准（pairwise registration），算法输出通常是一个4*4的刚体变换矩阵，包含旋转和平移关系，这个变换矩阵被应用在一个点云数据集，这个数据集被称作（source），然后这个数据集能够完美的与另一个数据集对齐，这个数据集称作是（target或者model）。

成对配准算法的流程如下图所示，这个图中表示了一次迭代，用户可以自行决定在任意步骤或者所有步骤进行循环。

![](http://pointclouds.org/documentation/tutorials/_images/block_diagram_single_iteration.jpg)


对于两个点云数据库的配准步骤如下描述：
- 对于每个点云数据集，找出能够最好表达这个数据集的感兴趣的点，或者叫做关键点
- 对于每个关键点计算描述子
- 结合两个数据集的特征描述符以及XYZ点坐标，基于特征和点的相似性，计算两个数据集的相关性
- 考虑到数据会存在噪声，不是所有的相关性是有效的，要排除不好的对应关系，以免它们对配准程序的干扰
- 从剩下的好的相关性中，估算运动变换。

## 配准模型

下面的过程介绍这个pipeline的每一步。

### 关键点
特征点就是在场景中具有特殊属性的感兴趣的点，比如书的角点，或者一个本写着“PCL"的书上面的字符”P“，在PCL中有很多种不同的关键点，比如NARF，SIFT，FAST。而且，也可以选择所有的点，或者其中的一个子集作为关键点集合。在问题”用两个Kinect数据集估算相关性“中，每一帧数据有300K个关键点，所有共有300K平方个相关性。

### 特征描述符
基于关键点可以计算每个关键点的特征。对于每个关键点，集成关键点的信息，并产生一个向量，用来比较每个关键点相似性。

### 相关性估计
从给定的两个数据集合中计算出的特征向量，寻找两个数据集特征重叠部分，用作关键特征。根据特征类型的不同，有不同的方法计算数据集的相关性。

- 对于点特征（用XYZ点表示特征），存在规则数据和非规则数据
1. 暴力枚举匹配
2. kd数据最近邻搜索（FLANN）
3. 在规则化的数据的图像空间检索
4. 在规则化数据的索引空间检索

- 对于不适用点坐标，而是使用特定特征的特征匹配，有下面的几种方法：
1. 暴力枚举
2. kd树最近邻搜索（FLANN）

- 另外对于搜索，区分两种相关性估计：
直接相关性估计搜索，也是默认的相关性估计，寻找点云数据集B中每一个点在数据集A中的相关性
- ”相“互相关性估计搜索，从数据集A中到数据集B估计，从数据集B中估计A，只两次计算相关性的交集。

### 相关性拒绝
并不是所有估计的相关性都是正确的，错误的相关性是对最终变换计算存在负面的影响，需要拒绝这些错误的相关性，可以通过RANSAC方法或者trimming down相关性的数量。

### 变换估计
最后一步是计算准确的变换。
- 基于相关性估算误差
- 估算相机姿态的刚体变换和最小化误差
- 优化点的结构
- SVD运动估计
- 在target数据集上对弈source数据集应用刚体变换（旋转和平移），并且可能会对每个关键点、关键点的自己、或者所有的关键点运行一个内部的ICP循环
- 迭代，直到达到手链标准


